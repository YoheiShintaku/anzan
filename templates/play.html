<!DOCTYPE html>
<html>
<head>
    <title>anzan</title>
    <link rel="stylesheet" 
        type="text/css"
        href="{{url_for('static', filename='style.css')}}">
</head>
{% block body %}
<div class='q'>
    <p><font id='num'></font></p>
    <div class='a'>    
        <p id='ans' onclick="send_clicked(this)"></p>
        <p id='ans1' onclick="send_clicked(this)"></p>
        <p id='ans2' onclick="send_clicked(this)"></p>
        <p id='ans3' onclick="send_clicked(this)"></p>
    </div>
</div>
<input type="button" value="start" onclick="start_clicked()" /><br>

<p id='judge'></p>
<p id='correct'></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script>
// global
var len = {{ len }}
var intervalSec = {{ intervalSec }}
var intervalMS;
var digit1 = {{ digit1 }}
var digit1_rate = {{ digit1_rate }}
var digit2;
var improve = "{{ improve }}"
var auto = "{{ auto }}".toLowerCase() === 'true'
var correct;
var wait_sec = 3
start_clicked()

function start_clicked(){
    intervalMS = intervalSec * 1000
    console.log(intervalMS)
    digit2 = digit1 - 1
    if (digit2==0) {digit2 = 1}

    document.getElementById('num').innerHTML = ''
    document.getElementById('ans').innerHTML = ''
    document.getElementById('ans1').innerHTML = ''
    document.getElementById('ans2').innerHTML = ''
    document.getElementById('ans3').innerHTML = ''
    document.getElementById('judge').innerHTML = ''
    document.getElementById('correct').innerHTML = ''

    function doSomethingLoop(i, maxCount) {
        if (i <= maxCount) {
            if (i >= wait_sec){doSomething(array[i-wait_sec])}
            else {doSomething(wait_sec-i)}
            setTimeout(function(){doSomethingLoop(++i, maxCount)}, intervalMS);
        } else {
            // 終了時の処理
            at_end()
        }
    }

    function doSomething(value) {
        document.getElementById('num').innerHTML = value
    }

    function at_end() {
            // 回答の選択肢を表示
            // 正解にノイズ付与
            ans_array = new Array()
            for (i=0;i<3;i++){                
                tmp = Math.round(Math.random()*10*0.4) - 2   // -2 ~ 2
                if (tmp==0){ // 正解と一致させない
                    if (Math.random()>0.5){
                        tmp = 1
                    } else {
                        tmp = -1
                    }
                }
                value = correct + tmp
                flg = false
                for (k=0;k<i;k++){  // 他候補と一致するか
                    if (value == ans_array[k]){
                        flg = true
                    }
                }
                if (flg){ // 
                    i--; // 戻ってもう一度
                } else {
                    ans_array.push(value);
                }
            }
            // 一つだけ正解にする
            index = Math.floor(Math.random() * 3) // 0<=random<1
            ans_array[index] = correct
            // 表示
            document.getElementById('num').innerHTML = ''
            document.getElementById('ans').innerHTML = 'select your answer'
            document.getElementById('ans1').innerHTML = ans_array[0]
            document.getElementById('ans2').innerHTML = ans_array[1]
            document.getElementById('ans3').innerHTML = ans_array[2]
    }

    var array = new Array();

    for (i=0; i < len; i++) {
        tmp = Math.random()
        if (tmp <= digit1_rate){ // 桁指定
            digit = digit1
        } else {
            digit = digit2
        }
        value = 0
        for (k=digit; k>0; k--){ // 各桁の数値を出す。randomは0.0..も含まれるのでこうしないと桁数制御しづらい
            tmp = Math.ceil(Math.random()*10) - 1; // 0-9
            if (tmp==0){
                if (k==digit){ // 最上位桁
                    tmp = 1
                }
            }
            value += tmp * Math.pow(10, k-1)
        }
        array.push(value)
    }
    correct = array.reduceRight(function(a,b){return a + b;});

    doSomethingLoop(0, len-1+wait_sec)
}

function send_clicked(element) {
    // mysqlのdatetime/postgreのtimestamp型のstringへ
    function Date_to_String(date){  
        y = date.getFullYear()
        month = date.getMonth() + 1
        d = date.getDate()
        h = date.getHours()
        minute = date.getMinutes()
        s = date.getSeconds()
        ms = date.getMilliseconds()
        string = y+'-'+month+'-'+d+' '+h+':'+minute+':'+s
        return string
    }

    // 回答取得
    ans = element.innerHTML
    ans = parseInt(ans, 10)

    // 正誤判定
    judge_str = 'Wrong'
    judge = 0
    if (ans==correct){
        judge_str = 'Correct'
        judge = 1
    }

    // 結果表示
    document.getElementById('judge').innerHTML = judge_str
    if (judge==0){
        document.getElementById('correct').innerHTML = correct
    }

    // 結果によって難易度変更
    if (auto){
        switch (judge){
            case 1: // 正解
                switch (improve){
                    case 'speed': // 速く
                        intervalSec = intervalSec - 0.1
                        break;
                    case 'digit': // 桁を多く
                        if (digit1_rate>=1){ // すでに配分がmaxなら1桁上げる
                            digit1 = digit1 + 1
                            digit1_rate = 0.2
                        } else { // 配分を上げる
                            digit1_rate = digit1_rate + 0.1
                        }
                        break;
                }
                break;
            case 0: // 不正解
                switch (improve){
                    case 'speed': // スピードは保持。桁を少なく
                        if (digit1_rate >= 0.2){ // 桁が多い数字の配分を下げる
                            digit1_rate = digit1_rate - 0.1
                        } else { // 十分配分が低い場合、桁を下げる
                            digit1 = digit1 - 1
                            digit1_rate = 1.0
                        }
                        break;
                    case 'digit': // 遅く
                        intervalSec = intervalSec + 0.1                    
                        break;
                }
                break;
        }
    }

    // dbへ送信
    user_id = 0
    date = new Date()
    t = Date_to_String(date)

    // ユーザーid, timestamp, 桁数, interval, 個数, 回答, 正答, 判定
    // flaskにjsonを渡す
    $.ajax({
    type: 'POST',
    url: '/insert',
    data: JSON.stringify ({
        user_id: user_id,
        t: t,
        digit: digit1,
        intervalSec: intervalSec,
        len: len,
        ans: ans,
        correct: correct,
        judge: judge,
    }), 
    success: function(data) { },
    contentType: "application/json",
    dataType: 'json'
    });    

    user_id = 0
    $.ajax({
        type: 'POST',
        url: '/setting',
        data: JSON.stringify ({
            user_id: user_id,
            len: len,
            intervalSec: intervalSec,
            digit1: digit1,
            digit1_rate: digit1_rate,
            auto: auto,
            improve: improve,
        }), 
        success: function(data) { },
        contentType: "application/json",
        dataType: 'json'
        });
}


</script>
{% endblock %}
</html>